<dialog closedby="none" #_assignment_detail_dialog class="min-w-800 max-w-1000" (close)="onClose()">
  <div class="p-24">
    <div class="grid grid-cols-[1fr_auto] gap-x-10 mb-24">
      <h2 class="text-24 font-bold">Chi tiết bài tập</h2>
      <button type="button" class="self-start __btn-img" (click)="onClose()">
        <img src="image/close-icon-black.svg" alt="close" class="w-[24px] h-[24px]"/>
      </button>
    </div>

    @if (post()) {
      <div class="mb-24">
        <h3 class="text-20 font-semibold mb-12">{{ post().title }}</h3>
        <div class="text-14 text-gray-600 mb-16">
          <div class="mb-8">Giáo viên: {{ post().teacherName }}</div>
          @if (post().dueDate) {
            <div class="mb-8">Hết hạn: {{ formatDate(post().dueDate) }}</div>
          }
          @if (post().totalPoints) {
            <div>Điểm tối đa: {{ post().totalPoints }}</div>
          }
        </div>
        <div class="text-14 text-gray-800 whitespace-pre-wrap mb-16">{{ post().content }}</div>
        
        @if (post().attachmentUrl) {
          <div class="mb-16">
            <a [href]="post().attachmentUrl" 
               [download]="getAttachmentFileName(post().attachmentUrl)"
               target="_blank" 
               rel="noopener noreferrer" 
               class="inline-flex items-center gap-x-8 px-16 py-8 bg-blue-50 text-blue-700 rounded-4 hover:bg-blue-100 transition-colors">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              <span>{{ getAttachmentFileName(post().attachmentUrl) }}</span>
            </a>
          </div>
        }
      </div>

      @if (isTeacher) {
        <!-- Teacher View -->
        <div class="mb-24">
          <h4 class="text-18 font-semibold mb-16">Danh sách học sinh</h4>
          
          @if (isLoading()) {
            <div class="text-center py-32 text-gray-500">Đang tải...</div>
          } @else {
            @if (students().length === 0) {
              <div class="text-center py-32 text-gray-500">Chưa có học sinh nào trong lớp</div>
            } @else {
              <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                  <thead>
                    <tr class="bg-gray-100 border-b border-gray-300">
                      <th class="text-left p-12 text-14 font-semibold text-gray-700">Tên học sinh</th>
                      <th class="text-left p-12 text-14 font-semibold text-gray-700">Email</th>
                      <th class="text-center p-12 text-14 font-semibold text-gray-700">Trạng thái</th>
                      <th class="text-left p-12 text-14 font-semibold text-gray-700">Thời gian nộp</th>
                      <th class="text-left p-12 text-14 font-semibold text-gray-700">Bài nộp</th>
                      <th class="text-center p-12 text-14 font-semibold text-gray-700">Điểm</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (student of students(); track student.studentId) {
                      <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="p-12 text-14">{{ student.studentName }}</td>
                        <td class="p-12 text-14 text-gray-600">{{ student.studentEmail }}</td>
                        <td class="p-12 text-center">
                          @if (student.hasSubmitted) {
                            <span class="inline-block px-12 py-4 bg-green-100 text-green-700 rounded-4 text-12 font-semibold">
                              Đã nộp
                            </span>
                          } @else {
                            <span class="inline-block px-12 py-4 bg-gray-100 text-gray-700 rounded-4 text-12 font-semibold">
                              Chưa nộp
                            </span>
                          }
                        </td>
                        <td class="p-12 text-14 text-gray-600">
                          @if (student.submittedAt) {
                            {{ formatDate(student.submittedAt) }}
                          } @else {
                            -
                          }
                        </td>
                        <td class="p-12 text-14">
                          @if (student.hasSubmitted) {
                            @if (student.submissionType === 'LINK') {
                              <a [href]="student.linkUrl" target="_blank" rel="noopener noreferrer" 
                                 class="text-blue-600 hover:underline">
                                Xem link
                              </a>
                            } @else if (student.submissionType === 'FILE') {
                              <button type="button" 
                                      class="__btn-2-sm border-0"
                                      (click)="downloadFile(student.fileUrl, student.fileName)">
                                {{ student.fileName || 'Tải file' }}
                              </button>
                            }
                          } @else {
                            -
                          }
                        </td>
                        <td class="p-12 text-center">
                          @if (student.hasSubmitted && student.submissionId) {
                            <input type="number" 
                                   [value]="student.earnedPoints ?? ''"
                                   (input)="onGradeInputChange(student.submissionId, $event)"
                                   [max]="post().totalPoints ?? undefined"
                                   min="0"
                                   step="0.1"
                                   class="w-80 px-8 py-4 text-14 border border-gray-300 rounded-8 text-center focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="-">
                          } @else {
                            <span class="text-gray-400">-</span>
                          }
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            }
          }
        </div>
      }
    }
  </div>

  <fieldset class="m-0 flex justify-end gap-x-6 border-t-1 border-x-0 border-b-0 border-gray-dd p-16">
    <button type="button" class="min-w-120 __btn-1" (click)="onClose()">Đóng</button>
  </fieldset>

  @if (showSubmitDialog()) {
    <app-assignment-submit-dialog
      #submitDialog
      [assignmentId]="post().postId"
      [submissionId]="studentSubmission()?.submissionId ?? null"
      (submitted)="onSubmissionSubmitted()"
      (closed)="onDialogClosed()">
    </app-assignment-submit-dialog>
  }
</dialog>

