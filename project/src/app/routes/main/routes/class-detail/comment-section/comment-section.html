<div class="comment-section">
  <!-- Comment Count -->
  @if (commentCount() > 0 || comments().length > 0) {
    <div class="comment-count mb-12">
      <div class="flex items-center gap-x-8 text-14 text-gray-700">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <span>{{ commentCount() || comments().length }} nhận xét về lớp học</span>
      </div>
    </div>
  }

  <!-- Add Comment Input -->
  <div class="comment-input-container mb-16">
    <div class="flex gap-x-12">
      <div class="comment-avatar">
        @if (getCurrentUserAvatarUrl()) {
          <img [src]="getCurrentUserAvatarUrl()" [alt]="getCurrentUserName()" class="avatar-image-small" (error)="onCurrentUserAvatarError($event)">
        } @else {
          <div class="avatar-circle-small">
            {{ getInitials() }}
          </div>
        }
      </div>
      <div class="flex-1">
        <div class="comment-input-wrapper">
          <textarea 
            [(ngModel)]="newComment" 
            class="comment-input" 
            rows="1" 
            placeholder="Thêm nhận xét trong lớp học...">
          </textarea>
          <button 
            type="button" 
            class="comment-send-btn"
            (click)="submitComment()"
            [disabled]="!newComment.trim()"
            [class.disabled]="!newComment.trim()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  @if (isLoading()) {
    <div class="text-center py-16 text-gray-500">Đang tải...</div>
  } @else {
    @for (comment of comments(); track comment.commentId) {
      <div class="comment-item mb-16">
        <div class="flex gap-x-12">
          <!-- Comment Avatar -->
          <div class="comment-avatar">
            @if (comment.userAvatarUrl) {
              <img [src]="comment.userAvatarUrl" [alt]="comment.userName" class="avatar-image-small" (error)="onAvatarError($event, comment.userName)">
            } @else {
              <div class="avatar-circle-small">
                {{ getCommentInitials(comment.userName) }}
              </div>
            }
          </div>
          
          <div class="flex-1">
            <div class="comment-header mb-4">
              <span class="text-14 font-semibold text-gray-900">{{ comment.userName }}</span>
              <span class="text-12 text-gray-600 mx-8">•</span>
              <span class="text-12 text-gray-600">{{ formatDate(comment.createdAt) }}</span>
              @if (isAuthor(comment)) {
                <span 
                  class="text-12 text-blue-600 hover:underline cursor-pointer ml-12" 
                  role="button"
                  tabindex="0"
                  (click)="startEdit(comment)"
                  (keyup.enter)="startEdit(comment)"
                  (keyup.space)="startEdit(comment)">Sửa</span>
                <span 
                  class="text-12 text-red-600 hover:underline cursor-pointer ml-8" 
                  role="button"
                  tabindex="0"
                  (click)="deleteComment(comment.commentId)"
                  (keyup.enter)="deleteComment(comment.commentId)"
                  (keyup.space)="deleteComment(comment.commentId)">Xóa</span>
              }
            </div>

            @if (editingCommentId === comment.commentId) {
              <div class="edit-form mb-8">
                <textarea [(ngModel)]="editContent" class="w-full p-8 border-1 border-gray-300 rounded-4 mb-8" rows="3"></textarea>
                <div class="flex gap-x-8">
                  <button type="button" class="px-12 py-4 bg-blue-600 text-white rounded-4 text-12" (click)="saveEdit(comment.commentId)">Lưu</button>
                  <button type="button" class="px-12 py-4 bg-gray-300 rounded-4 text-12" (click)="cancelEdit()">Hủy</button>
                </div>
              </div>
            } @else {
              <p class="comment-content-text">{{ comment.content }}</p>
            }

            <button 
              type="button" 
              class="reply-btn mt-4"
              (click)="startReply(comment.commentId)">
              Phản hồi
            </button>

            @if (replyingTo === comment.commentId) {
              <div class="reply-form mt-8 pl-16 border-l-2 border-gray-300">
                <textarea 
                  [(ngModel)]="replyContent" 
                  class="w-full px-16 py-8 border-1 border-gray-300 rounded-18 mb-8" 
                  rows="3" 
                  placeholder="Viết phản hồi...">
                </textarea>
                <div class="flex gap-x-8">
                  <button 
                    type="button" 
                    class="px-12 py-4 __btn-1-sm text-12"
                    (click)="submitReply(comment.commentId)"
                    [disabled]="!replyContent.trim()">
                    Phản hồi
                  </button>
                  <button 
                    type="button" 
                    class="px-12 py-4 __btn-2-sm text-12"
                    (click)="cancelReply()">
                    Hủy
                  </button>
                </div>
              </div>
            }

            @if (comment.replies && comment.replies.length > 0) {
              <div class="replies ml-48 mt-12">
                @for (reply of comment.replies; track reply.commentId) {
                  <div class="reply-item mb-12">
                    <div class="flex gap-x-12">
                    <div class="comment-avatar">
                      @if (reply.userAvatarUrl) {
                        <img [src]="reply.userAvatarUrl" [alt]="reply.userName" class="avatar-image-small" (error)="onAvatarError($event, reply.userName)">
                      } @else {
                        <div class="avatar-circle-small">
                          {{ getCommentInitials(reply.userName) }}
                        </div>
                      }
                    </div>
                      <div class="flex-1">
                        <div class="comment-header mb-4">
                          <span class="text-14 font-semibold text-gray-900">{{ reply.userName }}</span>
                          <span class="text-12 text-gray-600 mx-8">•</span>
                          <span class="text-12 text-gray-600">{{ formatDate(reply.createdAt) }}</span>
                          @if (isAuthor(reply)) {
                            <span 
                              class="text-12 text-blue-600 hover:underline cursor-pointer ml-12" 
                              role="button"
                              tabindex="0"
                              (click)="startEdit(reply)"
                              (keyup.enter)="startEdit(reply)"
                              (keyup.space)="startEdit(reply)">Sửa</span>
                            <span 
                              class="text-12 text-red-600 hover:underline cursor-pointer ml-8" 
                              role="button"
                              tabindex="0"
                              (click)="deleteComment(reply.commentId)"
                              (keyup.enter)="deleteComment(reply.commentId)"
                              (keyup.space)="deleteComment(reply.commentId)">Xóa</span>
                          }
                        </div>

                        @if (editingCommentId === reply.commentId) {
                          <div class="edit-form mb-8">
                            <textarea [(ngModel)]="editContent" class="w-full p-8 border-1 border-gray-300 rounded-4 mb-8" rows="3"></textarea>
                            <div class="flex gap-x-8">
                              <button type="button" class="px-12 py-4 bg-blue-600 text-white rounded-4 text-12" (click)="saveEdit(reply.commentId)">Lưu</button>
                              <button type="button" class="px-12 py-4 bg-gray-300 rounded-4 text-12" (click)="cancelEdit()">Hủy</button>
                            </div>
                          </div>
                        } @else {
                          <p class="comment-content-text">{{ reply.content }}</p>
                        }
                      </div>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>
    }

    @if (comments().length === 0) {
      <div class="text-center py-16 text-gray-500">Chưa có bình luận nào</div>
    }
  }
</div>


