@if (isLoading) {
  <div class="w-full flex justify-center py-32">Đang tải...</div>
} @else if (exam) {
  <!-- Camera Preview -->
  @if (showCameraPreview && videoElement) {
    <div #cameraWrapper 
         class="fixed z-50 cursor-move"
         [style.left.px]="cameraPosition.x"
         [style.top.px]="cameraPosition.y"
         (mousedown)="onDragStart($event)"
         style="user-select: none;">
        <div class="relative">
        <div #videoContainer class="w-320 h-240 rounded-8 border-2 border-gray-300 overflow-hidden bg-black shadow-lg"></div>
          <div class="absolute top-4 right-4 bg-red-500 text-white text-12 px-8 py-4 rounded-4">
            Đang giám sát
          </div>
        </div>
    </div>
  }

  <!-- Violation Alert -->
  @if (violationDetected) {
      <div class="bg-red-100 border border-red-400 text-red-700 px-16 py-12 rounded-8 mb-16">
      <p class="font-bold">Phát hiện vi phạm!</p>
      <p>Bài thi của bạn sẽ được tự động nộp với 0 điểm.</p>
    </div>
  }

  <!-- Tab/Focus Warning -->
  @if (!violationDetected && (tabSwitchCount > 0 || focusLossCount > 0)) {
    <div class="bg-yellow-100 border border-yellow-400 text-yellow-800 px-16 rounded-8 mb-16">
      <p class="font-semibold mb-4">Cảnh báo vi phạm:</p>
      @if (tabSwitchCount > 0) {
        <p class="text-14">Chuyển tab: {{ tabSwitchCount }}/{{ maxTabSwitches }}</p>
      }
      @if (focusLossCount > 0) {
        <p class="text-14">Mất focus: {{ focusLossCount }}/{{ maxFocusLoss }}</p>
      }
      <p class="text-14 mt-4 font-medium">Nếu tiếp tục vi phạm, bài thi sẽ được tự động nộp với 0 điểm.</p>
    </div>
  }

  <!-- Main Layout -->
  <div class="flex gap-24">
    <!-- Main Content Area -->
    <div class="flex-1">
      @if (currentQuestion) {
        <div class="bg-white rounded-12 p-24 shadow-md">
          <!-- Question Header -->
          <div class="flex items-center justify-between mb-16">
            <div class="flex items-center gap-12">
              <span class="px-12 py-6 bg-color-accent text-white text-14 font-semibold rounded-16">
                Câu hỏi {{ currentQuestionIndex + 1 }}
              </span>
              <span class="text-14 text-gray-600">trong {{ totalQuestions }}</span>
            </div>
            <button type="button"
                    class="__btn-2-sm flex items-center gap-8"
                    [class.bg-yellow-100]="isQuestionBookmarked(currentQuestionIndex)"
                    [class.border-yellow-400]="isQuestionBookmarked(currentQuestionIndex)"
                    [class.text-yellow-700]="isQuestionBookmarked(currentQuestionIndex)"
                    [disabled]="violationDetected || isSubmitting"
                    (click)="toggleBookmark()">
              <svg class="w-16 h-16" [class.fill-current]="isQuestionBookmarked(currentQuestionIndex)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
              </svg>
              {{ isQuestionBookmarked(currentQuestionIndex) ? 'Đã đánh dấu' : 'Đánh dấu' }}
            </button>
          </div>

          <!-- Question Text -->
          <h2 class="text-20 font-medium text-gray-900 leading-relaxed mb-24">
            {{ currentQuestion.questionText }}
          </h2>

          <!-- Answer Options -->
          <div class="flex flex-col gap-12 mb-24">
            @for (a of currentQuestion.answers || []; track a.answerId; let i = $index) {
              @let isSelected = getSelectedAnswerId(currentQuestion.questionId!) === a.answerId;
              @let isDisabled = violationDetected || isSubmitting;
              <div
                class="w-full p-20 rounded-12 text-left transition-all duration-200 flex items-center gap-16 relative min-h-[64px] bg-white border-2"
                [class.border-blue-500]="isSelected"
                [class.bg-blue-50]="isSelected"
                [class.border-gray-200]="!isSelected"
                [class.hover:border-gray-300]="!isSelected && !isDisabled"
                [class.hover:bg-gray-50]="!isSelected && !isDisabled"
                [class.opacity-50]="isDisabled"
                [class.cursor-not-allowed]="isDisabled"
                [class.cursor-pointer]="!isDisabled"
                role="button"
                tabindex="0"
                (click)="onSelect(currentQuestion.questionId!, a.answerId!)"
                (keydown.enter)="onSelect(currentQuestion.questionId!, a.answerId!)"
                (keydown.space)="onSelect(currentQuestion.questionId!, a.answerId!)"
              >
                <span class="w-48 h-48 rounded-12 flex items-center justify-center text-16 font-semibold shrink-0 transition-colors"
                      [class.bg-blue-500]="isSelected"
                      [class.text-white]="isSelected"
                      [class.bg-gray-100]="!isSelected"
                      [class.text-gray-600]="!isSelected"
                      [class.hover:bg-gray-200]="!isSelected && !isDisabled">
                  {{ getAnswerLabel(i) }}
                </span>
                <span class="leading-relaxed text-16 text-gray-900 flex-1">{{ a.answerText }}</span>
              </div>
            }
          </div>

          <!-- Navigation -->
          <div class="flex items-center justify-between pt-16 border-t border-gray-200">
            <button type="button"
                    class="__btn-2-sm flex items-center gap-8"
                    [disabled]="!canGoPrevious() || violationDetected || isSubmitting"
                    (click)="goToPrevious()">
              <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
              Trước
            </button>

            <div class="flex gap-4">
              @for (dot of getNavigationDots(); track $index) {
                <span class="w-8 h-8 rounded-full transition-colors"
                      [class.bg-color-accent]="dot === currentQuestionIndex"
                      [class.bg-gray-300]="dot !== currentQuestionIndex"></span>
              }
            </div>

            <button type="button"
                    class="__btn-2-sm flex items-center gap-8"
                    [disabled]="!canGoNext() || violationDetected || isSubmitting"
                    (click)="goToNext()">
              Tiếp
              <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </button>
          </div>
        </div>
      }

      <!-- Submit Button -->
      <div class="mt-24 justify-end flex">
        <button type="button" 
                class="__btn-1" 
                [disabled]="isSubmitting || violationDetected" 
                (click)="onSubmit()">
          Nộp bài
        </button>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="w-288 bg-white rounded-12 p-16 shadow-md h-fit sticky top-16">
      <!-- Exam Info -->
      <div class="mb-16">
        <div class="flex items-center gap-12 mb-12">
          <div class="w-40 h-40 rounded-8 bg-color-accent flex items-center justify-center mb-10">
            <svg class="w-20 h-20 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
          </div>
          <div class="flex-1 min-w-0">
            <h2 class="font-semibold text-14 text-gray-900 truncate">{{ exam.examName }}</h2>
            <p class="text-12 text-gray-600">Đang làm</p>
          </div>
        </div>

        <!-- Timer -->
        <div class="flex items-center gap-8 px-12 py-8 rounded-8 bg-gray-100 mb-12">
          <svg class="w-16 h-16 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span class="font-mono text-16 font-semibold text-gray-900">{{ fmtTime(remainingSeconds) }}</span>
        </div>

        <!-- Progress -->
        <div class="bg-gray-50 rounded-12 p-16 mb-20">
          <div class="flex justify-between items-center text-12 mb-8">
            <span class="text-gray-600">Tiến độ</span>
            <span class="font-semibold text-gray-900">
              {{ answeredCount }} / {{ totalQuestions }}
            </span>
          </div>
          <div class="h-8 bg-gray-200 rounded-full overflow-hidden relative">
            <div class="h-full bg-green-500 rounded-full transition-all duration-300"
                 [style.width.%]="progressPercentage"
                 [style.min-width.px]="answeredCount > 0 ? 4 : 0"></div>
          </div>
        </div>
      </div>

      <!-- Legend -->
      <div class="flex flex-wrap gap-12 text-12 mb-16">
        <div class="flex items-center gap-6">
          <div class="w-12 h-12 rounded-sm bg-green-500"></div>
          <span class="text-gray-600">Đã trả lời</span>
        </div>
        <div class="flex items-center gap-6">
          <div class="w-12 h-12 rounded-sm bg-yellow-400"></div>
          <span class="text-gray-600">Đã đánh dấu</span>
        </div>
        <div class="flex items-center gap-6">
          <div class="w-12 h-12 rounded-sm bg-white border border-gray-300"></div>
          <span class="text-gray-600">Chưa trả lời</span>
        </div>
      </div>

      <!-- Question Grid -->
      <div>
        <h3 class="text-12 font-medium text-gray-700 mb-8">Câu hỏi</h3>
        <div class="grid grid-cols-5 gap-8">
          @for (q of questions; track q.questionId; let i = $index) {
            @let isAnswered = isQuestionAnswered(i);
            @let isBookmarked = isQuestionBookmarked(i);
            @let isCurrent = i === currentQuestionIndex;
            @let isDisabled = violationDetected || isSubmitting;
            <button type="button"
                    class="w-48 h-48 rounded-12 font-medium text-15 transition-all duration-200 flex items-center justify-center"
                    [class.bg-green-500]="isAnswered"
                    [class.text-white]="isAnswered"
                    [class.border-green-500]="isAnswered"
                    [class.bg-yellow-400]="!isAnswered && isBookmarked"
                    [class.text-gray-900]="!isAnswered && isBookmarked"
                    [class.border-yellow-400]="!isAnswered && isBookmarked"
                    [class.bg-white]="!isAnswered && !isBookmarked"
                    [class.text-gray-700]="!isAnswered && !isBookmarked"
                    [class.border-gray-200]="!isCurrent"
                    [class.border-blue-600]="isCurrent"
                    [class.border-2]="!isCurrent"
                    [class.border-[3px]]="isCurrent"
                    [class.shadow-[0_0_0_3px_rgba(37,99,235,0.1)]]="isCurrent"
                    [class.hover:border-gray-300]="!isCurrent && !isDisabled"
                    [class.opacity-50]="isDisabled"
                    [class.cursor-not-allowed]="isDisabled"
                    [class.cursor-pointer]="!isDisabled"
                    [disabled]="isDisabled"
                    (click)="goToQuestion(i)">
              {{ i + 1 }}
            </button>
          }
        </div>
      </div>
    </div>
  </div>
} @else {
  <div>Không tìm thấy bài thi</div>
}
